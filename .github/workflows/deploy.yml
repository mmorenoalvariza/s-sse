name: Deploy Spring Boot to Elastic Beanstalk

on:
        push:
                branches:
                        - main # Or your desired branch

jobs:
        build-and-deploy:
                runs-on: ubuntu-latest
                steps:
                        - name: Checkout code
                          uses: actions/checkout@v4

                        - name: Set up Java
                          uses: actions/setup-java@v4
                          with:
                                  distribution: 'corretto' # Or your preferred Java distribution
                                  java-version: '17' # Or your application's Java version

                        - name: Build with Maven
                          run: mvn clean package -DskipTests

                        - name: Create Elastic Beanstalk Application
                          run: |
                                  aws elasticbeanstalk describe-applications --application-names sboot-demo-app || \
                                  aws elasticbeanstalk create-application --application-name sboot-demo-app --description "Spring Boot Demo Application"
                          env:
                                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                                  AWS_DEFAULT_REGION: us-east-1

                        - name: Deploy to Elastic Beanstalk
                          uses: einaregilsson/beanstalk-deploy@v21
                          with:
                                  aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
                                  aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                                  application_name: sboot-demo-app
                                  environment_name: sboot-demo-env
                                  version_label: ${{ github.sha }}
                                  region: us-east-1
                                  deployment_package: target/demo-0.0.1-SNAPSHOT.jar